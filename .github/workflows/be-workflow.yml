name: KTB Team20 Backend CI/CD (Maven Based)

on:
  push:
    branches: [ main ]
    paths:
      - 'apps/backend/**' 
      - '.github/workflows/be-workflow.yml'
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Java and Cache Maven Dependencies
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
          cache-dependency-path: apps/backend/pom.xml 
      - name: Run Maven Tests
        run: cd apps/backend && ./mvnw test -X

  build-and-push-image:
    needs: test
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - uses: docker/build-push-action@v5
        with:
          context: ./apps/backend
          file: ./apps/backendDockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/ktb-team20-be:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/ktb-team20-be:${{ github.sha }}

  deploy-parallel:
    needs: build-and-push-image
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    env:
      TARGET_GROUP_ARN: ${{ secrets.TARGET_GROUP_ARN }}
      APP_USER: ubuntu
      IMAGE_TAG: ${{ github.sha }}
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      DEPLOY_BUCKET: ${{ secrets.DEPLOY_BUCKET }} 

    steps:
      - uses: actions/checkout@v4

      # ... (AWS credentials ë° SSH key ìƒì„± ë¶€ë¶„ ìƒëµ - ë³€ê²½ ì—†ìŒ)

      # 5. S3ì—ì„œ .env íŒŒì¼ ë‹¤ìš´ë¡œë“œ (Runnerë¡œ ê°€ì ¸ì˜´)
      - name: Download .env from S3
        # ENV_S3_BUCKET ë³€ìˆ˜ê°€ env ë¸”ë¡ì— ì •ì˜ë˜ì–´ ìˆì–´ ì •ìƒ ì‘ë™ ì˜ˆìƒ
        run: aws s3 cp s3://${{ env.DEPLOY_BUCKET }}/backend/.env ./.env

      # ... (ëŒ€ìƒ ì¸ìŠ¤í„´ìŠ¤ IP í™•ì¸ ë¶€ë¶„ ìƒëµ - ë³€ê²½ ì—†ìŒ)

      # 6. ë³‘ë ¬ ë°°í¬ (SCP ì˜¤ë¥˜ ìˆ˜ì • ë° Docker-Compose ê²½ë¡œ í™•ì¸)
      - name: Deploy to all instances
        run: |
          IFS=' ' read -r -a IPS <<< "${{ steps.get-ips.outputs.instance_ips }}"
          PIDS=()

          for IP in "${IPS[@]}"; do
            echo "ğŸš€ ë°°í¬ ì‹œì‘: $IP"
            (
              # 6-A. íŒŒì¼ ì§ì ‘ ë˜ì ¸ì£¼ê¸° (SCP)
              # docker-compose.yaml íŒŒì¼ì´ ë£¨íŠ¸ì— ìˆë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.
              scp -i ./key.pem -o StrictHostKeyChecking=no ./docker-compose.yaml $APP_USER@$IP:/home/$APP_USER/docker-compose.yaml
              
              # 6-B. !!! ì´ì „ ì˜¤ë¥˜ ìˆ˜ì •: -i ì˜µì…˜ì— .env íŒŒì¼ì´ ì•„ë‹Œ í‚¤ íŒŒì¼(.pem) ì‚¬ìš© !!!
              scp -i ./key.pem -o StrictHostKeyChecking=no ./.env $APP_USER@$IP:/home/$APP_USER/.env
              
              # 2. ì›ê²© ì ‘ì†í•´ì„œ ì‹¤í–‰ë§Œ ì‹œí‚¤ê¸° (SSH)
              ssh -i ./key.pem -o StrictHostKeyChecking=no $APP_USER@$IP << EOF
                set -e
                echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
                sed -i 's|{{IMAGE_TAG}}|$IMAGE_TAG|g' /home/$APP_USER/docker-compose.yaml
                docker compose -f /home/$APP_USER/docker-compose.yaml pull
                docker compose -f /home/$APP_USER/docker-compose.yaml up -d --remove-orphans
          EOF
            ) & 
            PIDS+=($!)
          done

          for PID in "${PIDS[@]}"; do wait $PID; done
          rm -f ./key.pem
          echo "ğŸ‰ ëª¨ë“  ë°°í¬ ì™„ë£Œ!"